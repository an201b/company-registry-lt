{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card p-4 mb-4">
            <h3 class="mb-4">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö</h3>
            
            {% if message %}
            <div class="alert alert-success">{{ message }}</div>
            {% endif %}

            <form action="/settings" method="post">
                <div class="mb-3">
                    <label class="form-label fw-bold">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–µ—Å—Ç—Ä (JAR)</label>
                    <input type="text" name="jar_url" class="form-control" 
                           value="{{ settings['jar_url'].value if settings['jar_url'] else '' }}">
                    <div class="form-text">CSV —Ñ–∞–π–ª —Å —Å–∞–π—Ç–∞ registrucentras.lt</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–≤ –ù–î–° (VMI)</label>
                    <input type="text" name="pvm_url" class="form-control" 
                           value="{{ settings['pvm_url'].value if settings['pvm_url'] else '' }}">
                    <div class="form-text">–°—Å—ã–ª–∫–∞ –Ω–∞ API data.gov.lt –∏–ª–∏ —Ñ–∞–π–ª CSV.</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–°—Å—ã–ª–∫–∞ –Ω–∞ –£—Å—Ç–∞–≤–Ω–æ–π –∫–∞–ø–∏—Ç–∞–ª</label>
                    <input type="text" name="capital_url" class="form-control" 
                           value="{{ settings['capital_url'].value if settings['capital_url'] else '' }}">
                    <div class="form-text">CSV —Ñ–∞–π–ª —Å —Å–∞–π—Ç–∞ registrucentras.lt (JAR_KAPITALAS).</div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="/" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
                    <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫–∏</button>
                </div>
            </form>
            
            <hr class="my-4">
            
            <h5>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º</h5>
            <p class="text-muted small">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ. –ï—Å–ª–∏ –≥–∞–ª–æ—á–∫–∞ —Å–Ω—è—Ç–∞, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Ñ–∞–π–ª, —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ–µ (–±—ã—Å—Ç—Ä–æ).</p>

            <div class="mb-3 d-flex flex-wrap gap-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="chk_jar" checked>
                    <label class="form-check-label" for="chk_jar">–°–∫–∞—á–∞—Ç—å –†–µ–µ—Å—Ç—Ä</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="chk_pvm" checked>
                    <label class="form-check-label" for="chk_pvm">–°–∫–∞—á–∞—Ç—å –ù–î–°</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="chk_cap" checked>
                    <label class="form-check-label" for="chk_cap">–°–∫–∞—á–∞—Ç—å –ö–∞–ø–∏—Ç–∞–ª</label>
                </div>
            </div>

            <div class="d-flex align-items-center">
                <button onclick="forceUpdate()" class="btn btn-warning">
                    üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                </button>
                <span id="updateStatus" class="ms-3 fw-bold text-muted"></span>
            </div>
        </div>
    </div>
</div>

<script>
async function forceUpdate() {
    const status = document.getElementById('updateStatus');
    
    // –°—á–∏—Ç—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–æ—á–µ–∫
    const dlJar = document.getElementById('chk_jar').checked;
    const dlPvm = document.getElementById('chk_pvm').checked;
    const dlCap = document.getElementById('chk_cap').checked;

    status.innerText = "–ó–∞–ø—É—Å–∫...";
    status.className = "ms-3 fw-bold text-muted"; // –°–±—Ä–æ—Å —Ü–≤–µ—Ç–∞
    
    try {
        // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        // Python (FastAPI) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç true/false –≤ –±—É–ª–µ–≤—ã –∑–Ω–∞—á–µ–Ω–∏—è
        const url = `/api/v1/force-update?dl_jar=${dlJar}&dl_pvm=${dlPvm}&dl_cap=${dlCap}`;
        
        const response = await fetch(url, { method: 'POST' });
        
        if (response.ok) {
            const data = await response.json();
            status.innerText = "‚úÖ " + data.message;
            status.className = "ms-3 fw-bold text-success";
        } else {
            status.innerText = "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
            status.className = "ms-3 fw-bold text-danger";
        }
    } catch (e) {
        status.innerText = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
        status.className = "ms-3 fw-bold text-danger";
        console.error(e);
    }
}
</script>
{% endblock %}